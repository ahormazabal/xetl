<!--
Pipeline para archivo CI
-->
<pipeline name="generate_CI_file">
  <steps>

    <!-- load records from csv-->
    <step type="loaddb">
      <origin>
        SELECT
          p.fecha as fecha,
          p.nemo as nombre,
          0 as ajuste,
          s.valor_base as precio_de_cierre,
          0 as tir,
          p.mercado as mercado,
          p.grupo as grupo,
          p.familia as familia,
          p.valorizacion as valorizacion
        FROM parametros p
          LEFT OUTER JOIN sesion_de_mercado s
            ON p.fecha = '${DATE}'
               AND s.id_sesion = '${SESSION_ID}'
               AND p.fecha = s.fecha
               AND p.nemo = s.nemo
               AND s.time = 1
        WHERE p.fecha = '${DATE}'
        AND p.mercado = 'DE'
              AND s.id_sesion = '${SESSION_ID}'
              AND p.fecha = s.fecha
              AND p.nemo = s.nemo
              AND s.tipo_de_escenario = 'HISTORICO'
              AND s.time = 1
      </origin>
    </step>

    <step type="savecsv">
      <destination>${OUTPUT_DIR}/CI${DATE_SHORT}.csv</destination>
      <delimiter>;</delimiter>
      <write-header>false</write-header>
    </step>
  </steps>
</pipeline>
