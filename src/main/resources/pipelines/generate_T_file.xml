<!--
Pipeline para archivo D
-->
<pipeline name="generate_T_file">
  <steps>

    <!-- load records from csv-->
    <step type="loaddb">
      <origin>
        SELECT
          (SELECT f.fecha
           FROM factores f
           WHERE f.fecha &lt; '${DATE}'
           ORDER BY fecha DESC NULLS LAST
           LIMIT 1)                                      AS fecha,
          '${INTRADAY_ID}'                               AS correlativo,
          get_cod_arbol(sistema)                         AS arbol,
          get_cod_nivel(sistema, scm, cm, pt, cl, ct, f) AS nivel,
          edr.cm                                         AS cm,
          edr.pt                                         AS pt,
          edr.fecha                                      AS fecha_proyeccion,
          edr.cl                                         AS cl,
          edr.ct                                         AS ct,
          edr.f                                          AS f,
          edr.tt                                         AS riesgoT,
          edr.t_suma                                     AS riesgoTT,
          '--'                                           AS fin_archivo,
          edr.id_sesion,
          edr.tipo_de_escenario,
          edr.tipo_de_estimacion,
          edr.netting,
          edr.sistema,
          edr.scm,
          edr.t1,
          edr.t2,
          edr.t3
        FROM estimacion_de_riesgo edr
        WHERE id_sesion = '${SESSION_ID}'
              AND tipo_de_escenario = 'BACKTEST'
              AND (is_estatico(tipo_de_estimacion, t1, t2, t3, 1))
              -- Niveles
              AND (
                is_nivel_cclv(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_sistema(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_scm(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cm(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cl1(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_ct1(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cclv_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_sistema_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_scm_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cm_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cclv_cl(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_sistema_cl(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_scm_cl(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cm_cl(netting, sistema, scm, cm, pt, cl, ct, f)
              )
        ORDER BY
          pt ASC NULLS FIRST,
          cl ASC NULLS FIRST,
          ct ASC NULLS FIRST,
          f ASC NULLS FIRST,
          cm ASC NULLS FIRST,
          scm ASC NULLS FIRST,
          sistema ASC NULLS FIRST,
          tipo_de_estimacion ASC,
          fecha_proyeccion ASC
      </origin>
    </step>

    <!-- Save to file -->
    <!--<step type="stdout">-->
    <!--&lt;!&ndash;<delimiter>&#009;&#009;&#009;</delimiter>&ndash;&gt;-->
    <!--<delimiter>;</delimiter>-->
    <!--</step>-->
    <step type="savecsv">
      <destination>${OUTPUT_DIR}/T${INTRADAY_ID}${DATE_SHORT}.csv</destination>
      <delimiter>;</delimiter>
    </step>
  </steps>
</pipeline>
