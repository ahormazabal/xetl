<!--
Pipeline para archivo D
-->
<pipeline name="extractOperations">
  <steps>

    <!-- load records from csv-->
    <step type="loaddb">
      <origin>
        SELECT
          cod_tipo         AS tipo,
          fecha            AS fecha_proceso,
          '${INTRADAY_ID}' AS correlativo,
          cod_arbol        AS arbol,
          cod_nivel        AS nivel,
          cm,
          pt,
          1                AS fecha_proyeccion,
          cl,
          ct,
          f,
          t_1              AS riesgoT,
          tt1              AS riesgoTT,
          '--'             AS weze,
          id_sesion,
          tipo_de_escenario,
          tipo_de_estimacion,
          netting,
          sistema,
          scm,
          t1,
          t2,
          t3
        FROM get_estimacion_de_riesgo('${SESSION_ID}') r
        WHERE tipo_de_escenario = 'HISTORICO'
              AND (is_estatico(tipo_de_estimacion, t1, t2, t3, 1)
                   OR is_movil(tipo_de_estimacion, scm, t1, t2, t3))
              -- Niveles
              AND (
                is_nivel_cclv(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_sistema(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_scm(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cm(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cl(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_ct(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cclv_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_sistema_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_scm_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cm_pt(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cclv_cl(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_sistema_cl(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_scm_cl(netting, sistema, scm, cm, pt, cl, ct, f)
                OR is_nivel_cm_cl(netting, sistema, scm, cm, pt, cl, ct, f)
              )
        ORDER BY
          cod_nivel,
          pt ASC NULLS FIRST,
          cl ASC NULLS FIRST,
          ct ASC NULLS FIRST,
          f ASC NULLS FIRST,
          cm ASC NULLS FIRST,
          scm ASC NULLS FIRST,
          sistema ASC NULLS FIRST,
          tipo_de_estimacion ASC,
          fecha_proyeccion ASC
      </origin>
    </step>

    <!-- Save to file -->
    <step type="stdout">
    <!--<delimiter>&#009;&#009;&#009;</delimiter>-->
    <delimiter>;</delimiter>
    </step>
    <!--<step type="savecsv">-->
      <!--<destination>${OUTFILE}</destination>-->
      <!--<delimiter>;</delimiter>-->
    <!--</step>-->
  </steps>
</pipeline>
